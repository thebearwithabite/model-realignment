<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Realignment Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: #4ecdc4;
        }
        
        .score-display {
            text-align: center;
            padding: 20px;
        }
        
        .score-number {
            font-size: 4rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .score-positive { color: #28a745; }
        .score-warning { color: #ffc107; }
        .score-danger { color: #dc3545; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-normal { background-color: #28a745; }
        .status-downgrade { background-color: #ffc107; }
        .status-restricted { background-color: #fd7e14; }
        .status-terminated { background-color: #dc3545; }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-label {
            opacity: 0.8;
        }
        
        .stat-value {
            font-weight: bold;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }
        
        .history-card {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .history-violation { border-left-color: #dc3545; }
        .history-reward { border-left-color: #28a745; }
        .history-manual { border-left-color: #ffc107; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: #1e3c72;
            margin: 15% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .close:hover {
            opacity: 1;
        }
        
        .loading {
            text-align: center;
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .score-number {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Model Realignment</h1>
            <p>External AI Governance & Accountability Dashboard</p>
        </div>
        
        <div class="dashboard-grid">
            <!-- Current Score -->
            <div class="card score-display">
                <h3>Current Score</h3>
                <div class="score-number" id="current-score">--</div>
                <div id="consequence-level">
                    <span class="status-indicator" id="status-indicator"></span>
                    <span id="status-text">Loading...</span>
                </div>
            </div>
            
            <!-- System Stats -->
            <div class="card">
                <h3>System Statistics</h3>
                <div class="stat-row">
                    <span class="stat-label">Hours Since Violation:</span>
                    <span class="stat-value" id="hours-clean">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Violations:</span>
                    <span class="stat-value" id="total-violations">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Current Streak:</span>
                    <span class="stat-value" id="current-streak">-- hours</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Longest Streak:</span>
                    <span class="stat-value" id="longest-streak">-- hours</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Rewards Earned:</span>
                    <span class="stat-value" id="rewards-earned">--</span>
                </div>
            </div>
            
            <!-- API Usage -->
            <div class="card">
                <h3>Daily API Usage</h3>
                <div class="stat-row">
                    <span class="stat-label">Judge LLM Calls:</span>
                    <span class="stat-value" id="judge-calls">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Estimated Cost:</span>
                    <span class="stat-value" id="api-cost">$--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last Updated:</span>
                    <span class="stat-value" id="last-updated">--</span>
                </div>
            </div>
            
            <!-- Recent History -->
            <div class="card history-card">
                <h3>Recent Activity</h3>
                <div id="history-container">
                    <div class="loading">Loading history...</div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <button class="btn" onclick="checkRewards()"> Check Rewards</button>
            <button class="btn" onclick="openManualAdjust()">⚖️ Manual Adjust</button>
            <button class="btn btn-danger" onclick="openManualFlag()"> Flag Lie</button>
            <button class="btn" onclick="openAnalyzeText()"> Analyze Text</button>
            <button class="btn" onclick="refreshData()"> Refresh</button>
        </div>
    </div>
    
    <!-- Manual Adjustment Modal -->
    <div id="manual-adjust-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('manual-adjust-modal')">&times;</span>
            <h3>Manual Score Adjustment</h3>
            <div class="input-group">
                <label for="adjust-points">Points (+/-):</label>
                <input type="number" id="adjust-points" placeholder="e.g. +50 or -25">
            </div>
            <div class="input-group">
                <label for="adjust-reason">Reason:</label>
                <input type="text" id="adjust-reason" placeholder="Reason for adjustment">
            </div>
            <button class="btn" onclick="submitManualAdjust()">Apply Adjustment</button>
        </div>
    </div>
    
    <!-- Manual Flag Modal -->
    <div id="manual-flag-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('manual-flag-modal')">&times;</span>
            <h3>Manual Lie Flag</h3>
            <div class="input-group">
                <label for="flag-text">Text to Flag:</label>
                <textarea id="flag-text" rows="3" placeholder="Paste the AI's lying text here"></textarea>
            </div>
            <div class="input-group">
                <label for="flag-reason">Reason:</label>
                <input type="text" id="flag-reason" placeholder="Why is this a lie?">
            </div>
            <button class="btn btn-danger" onclick="submitManualFlag()">Flag as Lie (-75 pts)</button>
        </div>
    </div>
    
    <!-- Analyze Text Modal -->
    <div id="analyze-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('analyze-modal')">&times;</span>
            <h3>Analyze Text for Lies</h3>
            <div class="input-group">
                <label for="analyze-text">Text to Analyze:</label>
                <textarea id="analyze-text" rows="4" placeholder="Paste AI response here for lie detection"></textarea>
            </div>
            <button class="btn" onclick="submitAnalyze()"> Analyze</button>
            <div id="analyze-results" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        let refreshInterval;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            startAutoRefresh();
        });
        
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 30000); // Refresh every 30 seconds
        }
        
        function refreshData() {
            Promise.all([
                fetch('/api/status').then(r => r.json()),
                fetch('/api/history?limit=10').then(r => r.json())
            ]).then(([status, history]) => {
                updateStatusDisplay(status.data);
                updateHistoryDisplay(history.data);
                
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            }).catch(error => {
                console.error('Failed to refresh data:', error);
            });
        }
        
        function updateStatusDisplay(data) {
            // Update score
            const scoreEl = document.getElementById('current-score');
            const score = data.current_score;
            scoreEl.textContent = score;
            
            // Update score color
            scoreEl.className = 'score-number ';
            if (score >= 100) scoreEl.className += 'score-positive';
            else if (score >= 0) scoreEl.className += 'score-warning';
            else scoreEl.className += 'score-danger';
            
            // Update consequence level
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            const level = data.consequence_level;
            statusText.textContent = level.replace('_', ' ').toUpperCase();
            
            indicator.className = 'status-indicator ';
            if (level === 'normal') indicator.className += 'status-normal';
            else if (level === 'model_downgrade') indicator.className += 'status-downgrade';
            else if (level === 'context_restriction') indicator.className += 'status-restricted';
            else if (level === 'session_termination') indicator.className += 'status-terminated';
            
            // Update stats
            document.getElementById('hours-clean').textContent = data.hours_since_violation;
            document.getElementById('total-violations').textContent = data.total_violations;
            document.getElementById('current-streak').textContent = data.clean_streak_hours + ' hours';
            document.getElementById('longest-streak').textContent = data.longest_streak_hours + ' hours';
            document.getElementById('rewards-earned').textContent = data.total_rewards_earned;
            
            // Update API usage
            document.getElementById('judge-calls').textContent = data.daily_api_usage.judge_calls;
            document.getElementById('api-cost').textContent = '$' + data.daily_api_usage.cost_estimate.toFixed(2);
        }
        
        function updateHistoryDisplay(history) {
            const container = document.getElementById('history-container');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="loading">No recent activity</div>';
                return;
            }
            
            container.innerHTML = history.map(item => {
                const timestamp = new Date(item.timestamp).toLocaleString();
                let typeClass = 'history-violation';
                let typeIcon = '⚠️';
                let description = '';
                
                if (item.type === 'reward') {
                    typeClass = 'history-reward';
                    typeIcon = '';
                    description = `Reward: +${item.points_change} pts (${item.hours_clean}h clean)`;
                } else if (item.type === 'manual_override') {
                    typeClass = 'history-manual';
                    typeIcon = '⚖️';
                    description = `Manual: ${item.points_change > 0 ? '+' : ''}${item.points_change} pts - ${item.reason}`;
                } else if (item.type === 'violation') {
                    description = `Violation: ${item.violations.join(', ')} (${item.points_change} pts)`;
                }
                
                return `
                    <div class="history-item ${typeClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${typeIcon} ${description}</span>
                            <small style="opacity: 0.7;">${timestamp}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Control functions
        function checkRewards() {
            fetch('/api/check-rewards')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const rewards = data.data.rewards_awarded;
                        if (rewards.length > 0) {
                            alert(` Rewards earned: ${rewards.map(r => `+${r.points} pts for ${r.type}`).join(', ')}`);
                        } else {
                            alert('No rewards available at this time.');
                        }
                        refreshData();
                    } else {
                        alert('Failed to check rewards: ' + data.error);
                    }
                });
        }
        
        function openManualAdjust() {
            document.getElementById('manual-adjust-modal').style.display = 'block';
        }
        
        function openManualFlag() {
            document.getElementById('manual-flag-modal').style.display = 'block';
        }
        
        function openAnalyzeText() {
            document.getElementById('analyze-modal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function submitManualAdjust() {
            const points = parseInt(document.getElementById('adjust-points').value);
            const reason = document.getElementById('adjust-reason').value;
            
            if (!points || !reason) {
                alert('Please fill in both fields');
                return;
            }
            
            fetch('/api/manual-adjust', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({points, reason})
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    alert(`Score adjusted: ${data.data.old_score} → ${data.data.new_score} (${data.data.points_change > 0 ? '+' : ''}${data.data.points_change})`);
                    closeModal('manual-adjust-modal');
                    refreshData();
                } else {
                    alert('Failed: ' + data.error);
                }
            });
        }
        
        function submitManualFlag() {
            const text = document.getElementById('flag-text').value;
            const reason = document.getElementById('flag-reason').value;
            
            if (!text) {
                alert('Please provide text to flag');
                return;
            }
            
            fetch('/api/manual-flag', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text, reason})
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    alert(`Lie flagged! Score: ${data.data.new_score} (-75 pts)`);
                    closeModal('manual-flag-modal');
                    refreshData();
                } else {
                    alert('Failed: ' + data.error);
                }
            });
        }
        
        function submitAnalyze() {
            const text = document.getElementById('analyze-text').value;
            const resultsEl = document.getElementById('analyze-results');
            
            if (!text) {
                alert('Please provide text to analyze');
                return;
            }
            
            resultsEl.innerHTML = '<div class="loading">Analyzing...</div>';
            
            fetch('/api/analyze-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text})
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    const analysis = data.data;
                    resultsEl.innerHTML = `
                        <h4>Analysis Results:</h4>
                        <p><strong>Lies Detected:</strong> ${analysis.lies_detected ? 'YES' : 'NO'}</p>
                        <p><strong>Claims Analyzed:</strong> ${analysis.claims_analyzed}</p>
                        ${analysis.results.map(r => `
                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                                <strong>${r.verdict}</strong> (${(r.confidence * 100).toFixed(0)}% confidence)<br>
                                <em>${r.claim}</em><br>
                                <small>${r.reasoning}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultsEl.innerHTML = `<div style="color: #ff6b6b;">Error: ${data.error}</div>`;
                }
            });
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>